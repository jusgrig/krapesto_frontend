<!DOCTYPE html>
<html lang="lt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Dienos pietų meniu Krapesto restorane. Pirmadienis-Penktadienis, 11:00 - 16:00.">
  <title>Dienos pietų meniu - Krapesto</title>
  <link rel="icon" href="/public/favicon-k.svg" type="image/svg+xml">
  <link rel="icon" href="/public/favicon-k-32x32.png" sizes="32x32" type="image/png">
  <link rel="stylesheet" href="/css/styles.css">
  <style>
    .menu-category { margin-bottom: 2rem; }
    .menu-category h3 { font-size: 1.5rem; font-weight: 700; color: #047857; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #047857; }
    .menu-item { padding: 1rem 0; border-bottom: 1px solid #e5e7eb; }
    .menu-item:last-child { border-bottom: none; }
    .menu-item-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem; }
    .menu-item-name { font-weight: 600; font-size: 1.1rem; color: #1f2937; flex: 1; }
    .menu-item-price { color: #047857; font-weight: 700; font-size: 1rem; text-align: right; display: flex; flex-direction: column; gap: 0.25rem; flex-shrink: 0; margin-left: 1rem; }
    .menu-item-price span, .menu-item-price div { display: block; }
    .menu-item-description { color: #6b7280; font-size: 0.95rem; line-height: 1.6; margin-top: 0.5rem; }
    .complex-item { padding: 1rem 0; border-bottom: 1px solid #e5e7eb; }
    .complex-item:last-child { border-bottom: none; }
    .complex-item-header { display: flex; justify-content: space-between; align-items: flex-start; }
    .complex-item-name { font-weight: 600; font-size: 1.1rem; color: #1f2937; flex: 1; }
    .complex-item-price { color: #047857; font-weight: 700; font-size: 1rem; margin-left: 1rem; }
    #menu-container { min-height: 200px; overflow-x: hidden; max-width: 100%; box-sizing: border-box; }
    .loading { text-align: center; padding: 2rem; color: #6b7280; }
    .error-message { text-align: center; padding: 2rem; color: #dc2626; font-size: 1.1rem; font-weight: 600; }
    .menu-grid { display: grid; grid-template-columns: 1fr; gap: 1.5rem; max-width: 1200px; margin: 0 auto; overflow-x: hidden; width: 100%; box-sizing: border-box; }
    @media (min-width: 768px) { .menu-grid { grid-template-columns: repeat(2, 1fr); } }
    @media (min-width: 1024px) { .menu-grid { grid-template-columns: repeat(3, 1fr); } }
    .menu-day-card { background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 1.5rem; transition: all 0.3s; overflow: hidden; word-wrap: break-word; max-width: 100%; }
    .menu-day-card:hover { border-color: #047857; box-shadow: 0 4px 12px rgba(4, 120, 87, 0.1); }
    .back-button { display: inline-flex; align-items: center; color: #047857; text-decoration: none; font-weight: 600; font-size: 1rem; transition: color 0.2s; margin-bottom: 1rem; }
    .back-button:hover { color: #065f46; }
    .back-button svg { margin-right: 0.5rem; }
    .pdf-button { display: inline-flex; align-items: center; background: #047857; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 600; font-size: 1rem; cursor: pointer; transition: background 0.2s; }
    .pdf-button:hover { background: #065f46; }
    .pdf-button svg { margin-right: 0.5rem; }
  </style>
</head>
<body data-hero="daily_lunch">
  <div id="header-placeholder"></div>

  <main>
    <div id="hero-placeholder"></div>

    <section class="section bg-white">
      <div class="container">
        <div id="menu-container" class="loading">
          <p>Kraunamas meniu...</p>
        </div>
      </div>
    </section>
  </main>

  <div id="footer-placeholder"></div>

  <script src="/js/layout.js"></script>
  <script src="/js/main.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script>
    const language = 'lt';
    const urlParams = new URLSearchParams(window.location.search);
    let activeDate = urlParams.get('date');
    if (activeDate && !/^\d{4}-\d{2}-\d{2}$/.test(activeDate)) { activeDate = null; }
    
    const API_URL = 'http://57.128.249.100:8000/api/lunch-menu/week/';
    const POLL_INTERVAL = 15000;
    let pollTimer = null;
    
    function escapeHtml(text) { const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }
    function formatPrice(price) { return '€' + parseFloat(price).toFixed(2); }
    function formatDate(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString(language === 'lt' ? 'lt-LT' : 'en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    }
    
    function renderSingleMenu(menuData) {
      if (!menuData || !menuData.published) return '';
      const hasDishes = menuData.categories && menuData.categories.some(cat => cat.dishes && cat.dishes.length > 0);
      if (!hasDishes && (!menuData.complexes || menuData.complexes.length === 0)) return '';
      
      let html = `<div style="margin-bottom: 3rem;" class="menu-day-section" data-date="${menuData.date}">`;
      html += `<div style="margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">`;
      html += `<a href="/menu/daily-lunch/" class="back-button"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>Atgal</a>`;
      html += `<button onclick="generatePDF('${menuData.date}')" class="pdf-button"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>PDF</button>`;
      html += `</div>`;
      html += `<h2 style="font-size: 1.75rem; font-weight: 700; color: #047857; margin-bottom: 1.5rem; padding-bottom: 0.5rem; border-bottom: 3px solid #047857;">${formatDate(menuData.date)}</h2>`;
      
      if (menuData.categories && menuData.categories.length > 0) {
        menuData.categories.forEach(category => {
          if (!category.dishes || category.dishes.length === 0) return;
          const categoryName = language === 'lt' ? category.name_lt : category.name_en;
          html += `<div class="menu-category"><h3>${escapeHtml(categoryName)}</h3>`;
          category.dishes.forEach(dish => {
            const dishName = language === 'lt' ? dish.name_lt : dish.name_en;
            const dishIngredients = language === 'lt' ? dish.ingredients_lt : dish.ingredients_en;
            html += `<div class="menu-item"><div class="menu-item-header"><div class="menu-item-name">${escapeHtml(dishName)}</div><div class="menu-item-price">`;
            if (dish.half_price) {
              html += `<div>½ ${language === 'lt' ? 'porcijos' : 'size'}: ${formatPrice(dish.half_price)}</div><div>${language === 'lt' ? 'Pilna porcija' : 'Full size'}: ${formatPrice(dish.price)}</div>`;
            } else { html += `<span>${formatPrice(dish.price)}</span>`; }
            html += `</div></div>`;
            if (dishIngredients) { html += `<div class="menu-item-description">${escapeHtml(dishIngredients)}</div>`; }
            html += `</div>`;
          });
          html += `</div>`;
        });
      }
      
      if (menuData.complexes && menuData.complexes.length > 0) {
        html += `<div class="menu-category"><h3>${language === 'lt' ? 'Kompleksai' : 'Complexes'}</h3>`;
        menuData.complexes.forEach(complex => {
          if (!complex.dish_options || complex.dish_options.length === 0) return;
          complex.dish_options.forEach(option => {
            let displayName = '';
            if (option.soup && option.main_dish) {
              const soupName = language === 'lt' ? option.soup.name_lt : option.soup.name_en;
              const mainDishName = language === 'lt' ? option.main_dish.name_lt : option.main_dish.name_en;
              const soupSize = option.soup_size === 'half' ? ' ½ ' + (language === 'lt' ? 'porcijos' : 'size') : '';
              displayName = soupName + soupSize + (language === 'lt' ? ' ir ' : ' and ') + mainDishName;
            } else if (option.main_dish) { displayName = language === 'lt' ? option.main_dish.name_lt : option.main_dish.name_en; }
            else if (option.soup) { displayName = language === 'lt' ? option.soup.name_lt : option.soup.name_en; }
            else { displayName = language === 'lt' ? complex.name_lt : complex.name_en; }
            html += `<div class="complex-item"><div class="complex-item-header"><div class="complex-item-name">${escapeHtml(displayName)}</div><div class="complex-item-price">${formatPrice(complex.price)}</div></div></div>`;
          });
        });
        html += `</div>`;
      }
      html += `</div>`;
      return html;
    }
    
    function renderMenu(data) {
      const container = document.getElementById('menu-container');
      if (!container) return;
      container.className = '';
      let html = '', hasValidMenus = false;
      if (data.menus && Array.isArray(data.menus)) {
        const menusToShow = activeDate ? data.menus.filter(menu => menu.date === activeDate) : data.menus;
        menusToShow.forEach(menuData => { const menuHtml = renderSingleMenu(menuData); if (menuHtml) { html += menuHtml; hasValidMenus = true; } });
      } else if (data.date && (data.categories || data.complexes)) {
        if (!activeDate || data.date === activeDate) { const menuHtml = renderSingleMenu(data); if (menuHtml) { html += menuHtml; hasValidMenus = true; } }
      }
      if (!hasValidMenus || html === '') { container.className = 'error-message'; container.textContent = language === 'lt' ? 'Meniu nėra prieinamas' : 'Menu not available'; }
      else { container.innerHTML = html; }
    }
    
    async function fetchMenu() {
      try {
        const response = await fetch(API_URL, { method: 'GET', headers: { 'Accept': 'application/json' }, mode: 'cors' });
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();
        if (typeof data !== 'object' || data === null || !data.menus || !Array.isArray(data.menus)) throw new Error('Invalid response');
        renderMenu(data);
      } catch (error) {
        console.error('Failed to fetch menu:', error);
        const container = document.getElementById('menu-container');
        if (container) { container.className = 'error-message'; container.textContent = language === 'lt' ? 'Meniu nėra prieinamas' : 'Menu not available'; }
      }
    }
    
    function startPolling() { fetchMenu(); pollTimer = setInterval(fetchMenu, POLL_INTERVAL); }
    function stopPolling() { if (pollTimer) { clearInterval(pollTimer); pollTimer = null; } }
    if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', startPolling); } else { startPolling(); }
    window.addEventListener('beforeunload', stopPolling);
    
    function generatePDF(date) {
      const menuSection = document.querySelector(`.menu-day-section[data-date="${date}"]`);
      if (!menuSection) { alert('Meniu nerastas'); return; }
      const pdfContent = menuSection.cloneNode(true);
      const buttonsContainer = pdfContent.querySelector('div[style*="display: flex"]');
      if (buttonsContainer) buttonsContainer.remove();
      const dateHeader = pdfContent.querySelector('h2');
      if (dateHeader) dateHeader.remove();
      
      const opt = { margin: [10, 10, 10, 10], filename: `krapesto-menu-${date}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true, logging: false }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
      html2pdf().set(opt).from(pdfContent).save();
    }
  </script>
</body>
</html>
